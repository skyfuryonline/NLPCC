# NLPCC  
[BERT-EMD](https://github.com/lxk00/BERT-EMD)  
| 方案                          | KL变化    | Bleu变化  | KL距离baseline | Bleu距离baseline |
|-----------------------------|----------|----------|---------------|----------------|
| 概率分布的差异计算逐点L1或L2距离 | -83.45%  | 11.64%   | 3.54% ↑      | -4.92% ↓      |
| 基于CDF和vocab_indice       | -53.05%  | 26.05%   | 33.94% ↑     | 9.49% ↑       |
| 词嵌入相似度作为代价矩阵+top-k | 33.37%   | 16.42%   | 120.36% ↑    | -0.14% ↓      |
| 基于输入的嵌入构建代价矩阵，成本基于嵌入的欧几里得距离反映学生和教师模型在嵌入空间中的语义差异+top-k+分块 | 60.46%   | 48.39%   | 147.45% ↑    | 31.83% ↑     |
| 混合OT和KL(各占一半)         | -0.80%   | 34.02%   | 86.19% ↑     | 17.46% ↑      |
| 混合OT和KL(3：7)            | -2.45%   | 35.48%   | 84.54% ↑     | 18.92% ↑      |
| 原始KL蒸馏（0.5*CELoss+0.5*KL） | -86.99%  | 16.56%   | 0             | 0             |

补充说明：
- 直接用概率分布的差异（student_probs - teacher_probs），计算逐点L1或L2距离，简单的概率分布L1/L2损失，与Wasserstein距离的几何特性偏离
- 基于累积分布函数（CDF），计算CDF差异并用vocab_indices加权，更接近Wasserstein距离的定义（衡量分布间的“搬运成本”）引入 vocab 索引的距离信息，从而提供了一种自然的 metric 结构，使得 Wasserstein 计算在 NLP 任务（如词汇分布匹配）中更具物理意义。即vocab indice充当了代价矩阵
- 提取教师模型和学生模型top-k的词嵌入并用投影矩阵对齐维度。用1减余弦相似度矩阵充当代价矩阵。用Sinkhorn 算法构造运输矩阵T。最终的 OT 损失通过计算 𝑇 和代价矩阵的元素乘积的和获得
- 成本基于嵌入的欧几里得距离，反映学生和教师模型在嵌入空间中的语义差异。不显式构造完整的 (topk, topk)矩阵，而是基于样本点（嵌入）的距离动态计算 Sinkhorn 距离，节省内存并加速计算。
- 使用可训练的投影矩阵进行维度对齐。代价矩阵是计算学生和教师的 top-k 词向量的欧几里得距离，再用 Sinkhorn 计算最优传输矩阵。计算整个词汇表上的概率分布之间的 KL 散度

## 详细实验结果如下：

### Epoch = 10
| 方法 | KL散度 | Bleu | Rouge-L |
|------|--------|------|---------|
| **baseline(FKL) (2.0,2048,5e-4)** | 60.7225 → 15.5075 (−74.47%) | 0.0402 → 0.0561 (39.55%) | 0.1796 → 0.2131 (18.64%) |
| **概率分布逐差 (2.0,2048,5e-4)** | 60.7225 → 16.8256 (−72.28%) | 0.0402 → 0.0367 (−8.71%) | 0.1796 → 0.1979 (10.19%) |
| **CDF+vocab indice (2.0,2048,5e-4)** | 60.7225 → 32.8813 (−45.85%) | 0.0402 → 0.0588 (46.27%) | 0.1796 → 0.1944 (8.24%) |
| **method 5 (2.0,2048,5e-4, OT=0.5, topk=100)** | 60.7225 → 46.9175 (−22.76%) | 0.0402 → 0.0598 (48.76%) | 0.1796 → 0.2129 (18.54%) |
| **method 5 (2.0,2048,5e-4, OT=0.5, topk=150)** | 60.7225 → 47.0100 (−22.58%) | 0.0402 → 0.0587 (46.02%) | 0.1796 → 0.1972 (9.80%) |
| **method 6: cosine+train_proj (2.0,2048,5e-4, OT=0.5, topk=150)** | 60.7225 → 48.3275 (−20.42%) | 0.0402 → 0.0639 (58.96%) | 0.1796 → 0.2011 (11.97%) |
| **method 6: cosine+train_proj (2.0,2048,5e-4, OT=0.5, topk=100,lr余弦退火, l2正则)** | 60.7225 → 46.1000 (−24.08%) | 0.0402 → 0.0426 (5.97%) | 0.1796 → 0.1881 (4.73%) |
| **method 6: cosine+train_proj (2.0,2048,5e-4, OT=0.5, topk=100)** | 60.7225 → 45.1775 (−25.6%) | 0.0402 → 0.0543 (35.07%) | 0.1796 → 0.2053 (14.31%) |

### Epoch = 15
| 方法 | KL散度 | Bleu | Rouge-L |
|------|--------|------|---------|
| **method 5 (2.5,2048,5e-4, OT=0.7)** | 45.8275 → 42.8450 (−6.51%) | 0.0402 → 0.0527 (31.09%) | 0.1796 → 0.2166 (20.61%) |

### Epoch = 20
| 方法 | KL散度 | Bleu | Rouge-L |
|------|--------|------|---------|
| **baseline(FKL) (2.0,2048,5e-4)** | 60.7225 → 15.4537 (−74.55%) | 0.0402 → 0.0497 (23.63%) | 0.1796 → 0.2091 (16.43%) |
| **method 5 (2.0,2048,5e-4, OT=0.5, topk=100)** | 60.7225 → 60.0650 (−1.08%) | 0.0402 → 0.0616 (53.23%) | 0.1796 → 0.2209 (23.00%) |
| **method 5 (2.0,2048,5e-4, OT=0.5, topk=50)** | 60.7225 → 59.1125 (−2.65%) | 0.0402 → 0.0453 (12.69%) | 0.1796 → 0.2000 (11.36%) |
| **method 5 (2.0,2048,5e-4, OT=0.5, topk=150)** | 60.7225 → 55.5900 (−8.45%) | 0.0402 → 0.0682 (69.65%) | 0.1796 → 0.2205 (22.78%) |
| **method 6: cosine+train_proj (2.0,2048,5e-4, OT=0.5, topk=100, epoch=20)** | 60.7225 → 58.6500 (−3.41%) | 0.0402 → 0.0516 (28.36%) | 0.1796 → 0.1970 (9.69%) |




# shared task 8: PESC  
[esconv](https://huggingface.co/datasets/thu-coai/esconv)  
[augesc](https://huggingface.co/datasets/thu-coai/augesc)  
[empathetic_dialogues](https://huggingface.co/datasets/facebook/empathetic_dialogues)  
